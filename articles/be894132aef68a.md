---
title: "(C#)Expression Tree(å¼æœ¨)ã‚’ä½¿ã£ã¦å‹•çš„ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã™ã‚‹ã€‚"
emoji: "ğŸŒ²"
type: "tech"
topics: ["csharp"]
published: true
---

# Expression Treeã¨ã¯
Expression Tree(å¼æœ¨)ã¨ã¯ã€å¼(æ•°å¼)ã‚’æœ¨æ§‹é€ ã§è¡¨ã—ãŸã‚‚ã®ã€‚
ä¾‹ãˆã°ã€X + Yã€€ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/h3azqo3pagwwgeod9clu47edfogr)

Expression Treeã§è¡¨ã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãŠã‚ˆã³å®Ÿè¡Œå¯èƒ½ã§ã‚ã‚Š
å®Ÿè¡Œå¯èƒ½ãªã‚³ãƒ¼ãƒ‰ã®å‹•çš„ãªå¤‰æ›´ã‚„å‹•çš„ã‚¯ã‚¨ãƒªã®ä½œæˆãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

# ãƒ©ãƒ ãƒ€å¼ã‹ã‚‰ã®Expression Treeä½œæˆ

ãƒ©ãƒ ãƒ€å¼ãŒExpressionå‹ã®å¤‰æ•°ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹ã¨ã€åŒ¿åãƒ‡ãƒªã‚²ãƒ¼ãƒˆã§ã¯ãªãã€å¼æœ¨ã¨ã—ã¦ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚Œã¾ã™ã€‚
ä¾‹ãˆã°ã€ä»¥ä¸‹äºŒã¤ã®ã‚³ãƒ¼ãƒ‰ã¯åŒã˜æ„å‘³ã«ãªã‚Šã¾ã™ã€‚

```cs
Expression<Func<int, int>> exp = x => x + 5; 
```

```cs
// å¼•æ•°x ã®å¼
var arg = Expression.Parameter(typeof(int), "x");
// x + 5ã®å¼
var body = Expression.Add(x, Expression.Constant(5));
// x => x + 5ã®å¼
var exp = Expression.Lambda<Func<int, int>>(body, x);
```

Expression.Addãƒ¡ã‚½ãƒƒãƒ‰ã¯2é …æ¼”ç®—ã®åŠ ç®—ï¼ˆï¼‹ï¼‰ã§ã™ã€‚
ãã‚Œãã‚Œã®æ¼”ç®—å­ã«å¯¾å¿œã—ãŸãƒ¡ã‚½ãƒƒãƒ‰ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚

# Expression Treeã‚’ä½¿ã£ãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆ

Expression Treeã‚’ä½¿ã†ã¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å‹•çš„ç”Ÿæˆã‚‚å¯èƒ½ã§ã™ã€‚
ä»¥ä¸‹ã®InstanceCreatorã‚¯ãƒ©ã‚¹ã§ã¯å¼æœ¨ã‚’çµ„ã¿ç«‹ã¦ãŸã‚ã¨ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦ãƒ‡ãƒªã‚²ãƒ¼ãƒˆã«ã—ã¦è¿”ã—ã¦ã„ã¾ã™ã€‚

```cs
public static class InstanceCreator<T>
{
    /// <summary>
    /// Tå‹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã—ã¾ã™
    /// </summary>
    public static Func<T> Create => CreateInstance();
    public static Func<T> CreateInstance()
    {
        return Expression.Lambda<Func<T>>(Expression.New(typeof(T))).Compile();
    }
}
```

x => x + 5ã®ä¾‹ã‚’å‚è€ƒã«ã™ã‚‹ã¨ã€
body(x + 5)ã«ã‚ãŸã‚‹éƒ¨åˆ†ãŒ`Expression.New(typeof(T))`
Expression.Newãƒ¡ã‚½ãƒƒãƒ‰ã¯æŒ‡å®šã—ãŸå‹ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’ä½œæˆã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚
ä»¥ä¸‹ã®ã‚ˆã†ã«ä½¿ç”¨ã—ã¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã§ãã¾ã™ã€‚

```cs
public class Person { }
public class Test
{
  public void InstanceCreateTest()
  {
      var person = new Person();
      var expressionPerson = InstanceCreator<Person>.Create();
  }
}

```
new Person()ã¨InstanceCreater<Person>.Create()ã¯ã¨ã‚‚ã«Personã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

# å¼•æ•°ãŒå¿…è¦ãªå ´åˆã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆ

```cs
public static class InstanceCreator<TParam, TInstance>
{
    /// <summary>
    /// ä¸€ã¤ã®å¼•æ•°ã‚’å—ã‘å–ã£ã¦TInstanceå‹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã—ã¾ã™
    /// </summary>
    public static Func<TParam, TInstance> Create => CreateInstance();
    public static Func<TParam, TInstance> CreateInstance()
    {
        var argsType = new[] { typeof(TParam) };
        var constructor = typeof(TInstance).GetConstructor(argsType);
        var args = argsType.Select(Expression.Parameter).ToList();
        return Expression.Lambda<Func<TParam, TInstance>>(Expression.New(constructor, args), args).Compile();
    }
}

```

# ã©ã†ã„ã†ã¨ãã«ä½¿ã†ã®ã‹

ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ã‚’ä½¿ã£ãŸå ´åˆã®å‹•çš„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆãªã©ã«æ´»ç”¨ã§ãã¾ã™ã€‚
new()åˆ¶ç´„ã‚’ä½¿ãˆã°ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ã‚’ä½¿ã£ãŸå ´åˆã§ã‚‚ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ç”Ÿæˆã§ãã‚‹ã®ã§ã™ãŒã€é…ã„ã€‚
Expression Treeã‚’ä½¿ãˆã°ã€new() T ã‚ˆã‚Šã‚‚é€Ÿãã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”ŸæˆãŒã§ãã¾ã™ã€‚

# å‚è€ƒ

[å¼ãƒ„ãƒªãƒ¼](https://docs.microsoft.com/ja-jp/dotnet/csharp/programming-guide/concepts/expression-trees/)